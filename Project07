# %% [markdown]
# # Bobby : **Chapter 7. [ì‹œìŠ¤í…œ] Në°° ë¹ ë¥¸ ë³‘ë ¬ì²˜ë¦¬ ì›¹ í¬ë¡¤ëŸ¬ ë§Œë“¤ê¸°**
# 
# ## 7. ë³‘ë ¬ì²˜ë¦¬ ì›¹ í¬ë¡¤ëŸ¬ ë§Œë“¤ê¸° ğŸš€ 
# 

# %% [markdown]
# > ### ì§„í–‰ ìˆœì„œ
# >  1. ë¡œê¹…(logging) ì„¤ì •
# >  2. ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
# >  3. ì›¹ í¬ë¡¤ëŸ¬ ë§Œë“¤ê¸°
# >  4. ë³‘ë ¬ì²˜ë¦¬ ì„¸íŒ…
# >  5. ì‹¤í–‰ ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •
# >  6. ë§¤ê°œë³€ìˆ˜ë¥¼ ì…ë ¥ ë°›ëŠ” ì‹œìŠ¤í…œ ëª…ë ¹ì–´ ì‹¤í–‰

# %% [markdown]
# #### 7-1. ë¡œê¹…(logging) ì„¤ì •

# %%
import logging

# ë¡œê±° ìƒì„±
logger = logging.getLogger()

# ë¡œê·¸ì˜ ì¶œë ¥ ê¸°ì¤€ ì„¤ì •
logger.setLevel(logging.INFO)

# log í˜•ì‹ ì§€ì •
formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')

# log ì¶œë ¥
stream_handler = logging.StreamHandler()
stream_handler.setFormatter(formatter)
logger.addHandler(stream_handler)

# log íŒŒì¼ ìƒì„±
file_handler = logging.FileHandler('output.log')
file_handler.setFormatter(formatter)
logger.addHandler(file_handler)

# %% [markdown]
# #### 7-2. ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸

# %%
'''
import platform, psutil
import os

def printSystemInfor():
    logger.info(f''' 
        OS                   :\t {platform.system()}
        OS Version           :\t {platform.version()}
        OS                   :\t {platform.system()}
        OS Version           :\t {platform.version()}
        Process information  :\t {platform.processor()}
        Process Architecture :\t {platform.machine()}
        CPU Cores            :\t {os.cpu_count()}   
        RAM Size             :\t {str(round(psutil.virtual_memory().total / (1024.0 **3)))+"(GB)"} 
    ''')
'''

import platform
import psutil
import os
import logging

# Logger ì„¤ì •
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def printSystemInfo():   # MAC ìš´ì˜ì²´ì œ í™•ì¸
    try:
        # CPU ì •ë³´ ë³´ì™„
        cpu_info = platform.processor() or "Unknown (Check compatibility)"
        if not cpu_info or cpu_info == "i386":
            cpu_info = "Apple Silicon (ARM)" if platform.machine() == "arm64" else "Intel (x86_64)"

        logger.info(f''' 
        OS                   :\t {platform.system()}
        OS Version           :\t {platform.mac_ver()[0]}
        Process information  :\t {cpu_info}
        Process Architecture :\t {platform.machine()}
        CPU Cores            :\t {os.cpu_count()}
        RAM Size             :\t {str(round(psutil.virtual_memory().total / (1024.0 **3)))+" GB"} 
        ''')
    except Exception as e:
        logger.error(f"Error while fetching system information: {e}")


# %%
printSystemInfor()

# %% [markdown]
# ### 7-2-1 ë§¤ê°œë³€ìˆ˜ ì…ë ¥ ë°›ê¸°
# 
# ë§¤ê°œ ë³€ìˆ˜ë€?
# í”„ë¡œê·¸ë¨ ëª…ë ¹í–‰ì—ì„œ ì‚¬ìš©ìë¡œë¶€í„° ì…ë ¥ ë°›ëŠ” ê°’ (í˜¹ì€ ì¸ì)
# ì™¸ë¶€ì—ì„œ ì…ë ¥ë°›ì€ ê°’ì— ë”°ë¼ í”„ë¡œê·¸ë¨ ë™ì‘ì´ ë‹¬ë¼ì ¸ì•¼ í•  ê²½ìš° ì£¼ë¡œ ì‚¬ìš©
# 
# sys.argv
# - íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì „ë‹¬í•œ ëª…ë ¹í–‰ ë§¤ê°œë³€ìˆ˜ë¥¼ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆ
# - list() í˜•ì‹ì˜ ë°˜í™˜ê°’ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì—¬ëŸ¬ê°œì˜ ì¸ìë¥¼ ë‹¤ë£° ë•Œ í¸í•©ë‹ˆë‹¤.

# %%
# ì‹¤í–‰ ê²°ê³¼ í™•ì¸
import sys
print(sys.argv)

# %% [markdown]
# #### 7-3. ì›¹ í¬ë¡¤ëŸ¬ ë§Œë“¤ê¸°

# %%
from bs4 import BeautifulSoup
import requests

# %%
# ë„¤ì´ë²„ ì—°í•©ë‰´ìŠ¤ URL
url1 = 'https://news.naver.com/main/list.naver?mode=LSD&mid=sec&sid1=100'  #ì •ì¹˜
url2 = 'https://news.naver.com/main/list.naver?mode=LSD&mid=sec&sid1=101'  #ê²½ì œ 
url3 = 'https://news.naver.com/main/list.naver?mode=LSD&mid=sec&sid1=102'  #ì‚¬íšŒ
url4 = 'https://news.naver.com/main/list.naver?mode=LSD&mid=sec&sid1=103'  #ìƒí™œ/ë¬¸í™” ì†ë³´
url5 = 'https://news.naver.com/main/list.naver?mode=LSD&mid=sec&sid1=104'  #ì„¸ê³„
url6 = 'https://news.naver.com/main/list.naver?mode=LSD&mid=sec&sid1=105'  #IT/ê³¼í•™

# %% [markdown]
# [html í—¤ë” ì •ë³´ ì¼ëŒ ì‚¬ì´íŠ¸](https://www.useragentstring.com/pages/useragentstring.php)

# %%
def web_crawler(url):
    # í—¤ë” ì„¤ì •
    headers = {"User-Agent":"Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36"}
    
    # ì„œë²„ ì‘ë‹µ í™•ì¸
    response = requests.get(url, headers=headers)

    # BeautifulSoup ê°ì²´ ìƒì„±
    beautifulSoup = BeautifulSoup(response.content, "html.parser")

    # í˜ì´ì§€ ì œëª© í¬ë¡¤ë§
    print(beautifulSoup.title.string)

    # ê¸°ì‚¬ ì œëª© í¬ë¡¤ë§
    print(beautifulSoup.find("ul", attrs={"class":"type06_headline"}).get_text())

# %%
# í¬ë¡¤ëŸ¬ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
web_crawler(url3)

# %% [markdown]
# #### 7-4. ë³‘ë ¬ì²˜ë¦¬ ì„¸íŒ…

# %%
# Pycharm ì—ì„œ ì‹¤í–‰ í™•ì¸
if __name__=='__main__':
    from multiprocessing import Pool
    import time
    
    url_list = [url1, url2, url3, url4, url5, url6]
    
    logger.info(f''' ë©€í‹°í”„ë¡œì„¸ìŠ¤ê°€ ì‹œì‘ë©ë‹ˆë‹¤. ''')
    start_time = time.time()
    
    pool = Pool(processes=3)                          # 3ê°œ CPU ì½”ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    result = pool.map(web_crawler, url_list)          # ê° URL ì— ì›¹ í¬ë¡¤ëŸ¬ í• ë‹¹
    
    pool.close()     # í’€ë§ ì¢…ë£Œ
    pool.join()      # ê²°ê³¼ í•©ì¹˜ê¸°

    
    logger.info(f''' ë©€í‹°í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ''')
    logger.info("--- %s seconds ---" % (time.time() - start_time))

# %% [markdown]
# #### 7-4. ì‹¤í–‰ ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •

# %%
def main():
    from multiprocessing import Pool
    import time
    
    url_list = [url1, url2, url3, url4, url5, url6]
    
    logger.info(f''' ë©€í‹°í”„ë¡œì„¸ìŠ¤ê°€ ì‹œì‘ë©ë‹ˆë‹¤. ''')
    start_time = time.time()
    
    pool = Pool(processes=3)                          # 3ê°œ CPU ì½”ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    result = pool.map(web_crawler, url_list)          # ê° URL ì— ì›¹ í¬ë¡¤ëŸ¬ í• ë‹¹
    
    pool.close()     # í’€ë§ ì¢…ë£Œ
    pool.join()      # ê²°ê³¼ í•©ì¹˜ê¸°
    
    logger.info(f''' ë©€í‹°í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ''')
    logger.info("--- %s seconds ---" % (time.time() - start_time))

    
# Pycharm ì—ì„œ ì‹¤í–‰ í™•ì¸
if __name__=='__main__':
    import schedule 
    
    # 3ì´ˆì— í•œë²ˆì”© ë©”ì¸ í•¨ìˆ˜ ì‹¤í–‰
    schedule.every(3).seconds.do(main)  # ì´ë²¤íŠ¸ ë“±ë¡
    
    # ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰
    while True:
        schedule.run_pending()
    

# %% [markdown]
# #### 7-5. ë§¤ê°œë³€ìˆ˜ë¥¼ ì…ë ¥ë°›ëŠ” ì‹œìŠ¤í…œ ëª…ë ¹ì–´ ì‹¤í–‰

# %%
def main(cpu=3):
    from multiprocessing import Pool
    import time
    
    url_list = [url1, url2, url3, url4, url5, url6]
    
    logger.info(f''' ë©€í‹°í”„ë¡œì„¸ìŠ¤ê°€ ì‹œì‘ë©ë‹ˆë‹¤. ''')
    start_time = time.time()
    
    pool = Pool(processes=cpu)                        # Nê°œ CPU ì½”ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    result = pool.map(web_crawler, url_list)          # ê° URL ì— ì›¹ í¬ë¡¤ëŸ¬ í• ë‹¹
    
    pool.close()     # í’€ë§ ì¢…ë£Œ
    pool.join()      # ê²°ê³¼ í•©ì¹˜ê¸°
    
    logger.info(f''' ë©€í‹°í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ''')
    logger.info("--- %s seconds ---" % (time.time() - start_time))

    
# Pycharm ì—ì„œ ì‹¤í–‰ í™•ì¸
if __name__=='__main__':
    import argparse
    import schedule 
    
    ''' ì…ë ¥ ë§¤ê°œë³€ìˆ˜ ì„¤ì • '''
    parser = argparse.ArgumentParser()  
    parser.add_argument('--cpu', type=int, default=3, help="ë©€í‹°í”„ë¡œì„¸ìŠ¤ CPU ìˆ˜")
    parser.add_argument('--run_interval', type=int, default=5, help="ì›¹ í¬ë¡¤ëŸ¬ ì‹¤í–‰ ì£¼ê¸°(ì´ˆ)")
    args = parser.parse_args()         # ë§¤ê°œë³€ìˆ˜ íŒŒì‹±
    cpu = args.cpu
    interval = args.run_interval
    
    logger.info(f''' 
        CPU ì‚¬ìš©                :\t {cpu} ì½”ì–´
        í”„ë¡œê·¸ë¨ ì‹¤í–‰ì£¼ê¸°        :\t {interval} ì´ˆ
    ''')

    # Nì´ˆì— í•œë²ˆì”© ë©”ì¸ í•¨ìˆ˜ ì‹¤í–‰
    schedule.every(interval).seconds.do(main, cpu)  # ì´ë²¤íŠ¸ ë“±ë¡
    
    # ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰
    while True:
        schedule.run_pending()
    


